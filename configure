#!/bin/bash
function help()
{
    echo "Usage: ./configure [OPTIONS]"
    echo ""
    echo "  -h, --help"
    echo "              Print help message"
    echo "  -L, --TOKDBG"
    echo "              Enable lexer debugging output"
    echo "  -P, --PARDBG"
    echo "              Enable parser debugging output"
    echo "  -S, --SEMDBG"
    echo "              Enable semantic analyzer debugging output"
    echo "  -C, --CODEDBG"
    echo "              Enable code generator debugging output"
    echo ""
    echo "If no argument is provided, cmake is invoked with"
    echo "all preprocessor flags set to off by default."
    echo ""
    echo "@author: Foivos Tsimpourlas"
    echo "@webpage: <https://github.com/fivosts/MLog>"
    exit $1
}

function parse_arguments()
{
    for arg in "${ARGS[@]}"; do
    case "$arg" in
        -h|--help)
            help 0
            ;;
	    -SC|--SCDBG)
	        CMAKE_ARGS+="-DSCDBG=ON"
	        ;;
        -T|--TOKDBG)
            CMAKE_ARGS+="-DTOKDBG=ON"
            ;;
	    -L|--LEXDBG)
	        CMAKE_ARGS+="-DLEXDBG=ON"
	        ;;
        -P|--PARDBG)
            CMAKE_ARGS+="-DPARDBG=ON"
            ;;
        -S|--SEMDBG)
            CMAKE_ARGS+="-DSEMDBG=ON"
            ;;
        -C|--CODEDBG)
            CMAKE_ARGS+="-DCODEDBG=ON"
            ;;
        *)
            echo "configure: Unrecognized option " $arg
            help 1
            ;;
    esac
    done
}

function setup_deps()
{
    echo "Scanning for apt package dependencies"

    while IFS="" read -r DEP_PACK || [ -n "$DEP_PACK" ]
    do
        PKG_OK=$(dpkg-query -W --showformat='${Status}\n' $DEP_PACK|grep "install ok installed")
        # echo Checking for somelib: $PKG_OK
        if [ "" == "$PKG_OK" ]; then
        echo "Installing $DEP_PACK"
        sudo apt --yes install $DEP_PACK
        else
            echo "$DEP_PACK is installed"
        fi
    done < DEPS.txt
}

function build_and_compile()
{
    echo "Configuring MLog"
    if [ ! -d "build" ]; then 
        mkdir build
    fi

    cd build && cmake .. $CMAKE_ARGS || (echo "Cmake config failed: Error $$"; return $$)
    make || (echo "Compilation failed: Error $$"; return $$)
    return 0
}

declare -a ARGS=("$@")
declare -a CMAKE_ARGS=()

parse_arguments
setup_deps
build_and_compile
exit $?
